<div align="center">
  <h1>wpress-extract</h1>
  <p>
    A simple CLI tool to unpack <code>.wpress</code> files generated by the <a href="https://wordpress.org/plugins/all-in-one-wp-migration/" target="_blank" rel="noopener">All-in-One WP Migration</a> Wordpress plugin.
  </p>
  <hr />
  <p>
    <img src="https://imgs.xkcd.com/comics/standards.png" alt="A funny comic from xkcd.com about creating new standards in computer industry" />
    <br />
    <sub>"Standards" by <a href="https://xkcd.com/927/">xkcd</a>.</sub>
  </p>
</div>

## Usage

Download the appropriate binary for your system from the [releases page](https://github.com/ofhouse/wpress-extract/releases).

```sh
# Extract a wpress file
./wpress-extract -input your-migration.wpress

# Or specify custom output directory
./wpress-extract -input your-migration.wpress -out ./output-dir

# Force overwrite existing directory
./wpress-extract -input your-migration.wpress -force
```

The command then creates a new directory with the same name (in this example `your-migration/`) where it extracts the content of the archive into.

### Options

You can customize the standard behavior of the `wpress-extract` command with these custom options that can be added:

```sh
wpress-extract --out ./alternate-output your-migration.wpress
```

| Option            | Description                                                                           |
| ----------------- | ------------------------------------------------------------------------------------- |
| `-o, --out <dir>` | Define an alternate directory where the archive should be extracted to.               |
| `-f, --force`     | Skip the check if the output directory already exists and override the content in it. |

## Acknowledgements

The functionality of this package is inspired by the [Wpress-Extractor](https://github.com/fifthsegment/Wpress-Extractor) tool.
Since the provided binaries stopped working on MacOS and no solution for Linux is available I created this tool as a cross-platform alternative.

## Author

<!-- prettier-ignore-start -->

| [<img src="https://avatars0.githubusercontent.com/u/472867?v=4" width="100px;"/><br /><sub><b>Felix Haus</b></sub>](https://github.com/ofhouse)<br /><sub>[Website](https://felix.house/) â€¢ [Twitter](https://twitter.com/ofhouse)</sub>|
| :---: |

<!-- prettier-ignore-end -->

## License

MIT - see [LICENSE](./LICENSE) for details.
package main

import (
	"bytes"
	"encoding/binary"
	"flag"
	"fmt"
	"io"
	"os"
	"path/filepath"
	"time"
)

const (
	headerSize      = 4377
	chunkSize       = 512
	headerChunkEOF  = "\x00" // Simplified EOF check
)

type FileHeader struct {
	Name   string
	Size   int64
	MTime  time.Time
	Prefix string
}

func main() {
	inputFile := flag.String("input", "", "Path to .wpress file")
	outputDir := flag.String("out", "", "Output directory")
	force := flag.Bool("force", false, "Overwrite existing files")
	flag.Parse()

	if *inputFile == "" {
		fmt.Println("Error: Input file required")
		os.Exit(1)
	}

	if err := extract(*inputFile, *outputDir, *force); err != nil {
		fmt.Printf("Error: %v\n", err)
		os.Exit(1)
	}
}

func extract(inputPath, outputPath string, force bool) error {
	file, err := os.Open(inputPath)
	if err != nil {
		return fmt.Errorf("open input file: %w", err)
	}
	defer file.Close()

	if outputPath == "" {
		base := filepath.Base(inputPath)
		outputPath = base[:len(base)-len(filepath.Ext(base))]
	}

	if !force {
		if _, err := os.Stat(outputPath); err == nil {
			return fmt.Errorf("output directory exists - use --force to overwrite")
		}
	}

	if err := os.MkdirAll(outputPath, 0755); err != nil {
		return fmt.Errorf("create output directory: %w", err)
	}

	for {
		header, err := readHeader(file)
		if err == io.EOF {
			break
		}
		if err != nil {
			return fmt.Errorf("read header: %w", err)
		}

		destPath := filepath.Join(outputPath, header.Prefix, header.Name)
		if err := os.MkdirAll(filepath.Dir(destPath), 0755); err != nil {
			return fmt.Errorf("create directory structure: %w", err)
		}

		if err := writeFile(file, destPath, header.Size); err != nil {
			return fmt.Errorf("write file: %w", err)
		}
	}

	return nil
}

func readHeader(r io.Reader) (*FileHeader, error) {
	buf := make([]byte, headerSize)
	n, err := r.Read(buf)
	if err != nil || n < headerSize {
		return nil, io.EOF
	}

	if bytes.Equal(buf[:1], []byte(headerChunkEOF)) {
		return nil, io.EOF
	}

	return &FileHeader{
		Name:   string(bytes.Trim(buf[0:255], "\x00")),
		Size:   readInt64(buf[255:269]),
		MTime:  time.Unix(readInt64(buf[269:281]), 0),
		Prefix: string(bytes.Trim(buf[281:headerSize], "\x00")),
	}, nil
}

func readInt64(b []byte) int64 {
	return int64(binary.LittleEndian.Uint64(b[:8]))
}

func writeFile(r io.Reader, dest string, size int64) error {
	f, err := os.Create(dest)
	if err != nil {
		return err
	}
	defer f.Close()

	remaining := size
	buf := make([]byte, chunkSize)

	for remaining > 0 {
		readSize := chunkSize
		if remaining < chunkSize {
			readSize = int(remaining)
		}

		n, err := r.Read(buf[:readSize])
		if err != nil {
			return err
		}

		if _, err := f.Write(buf[:n]); err != nil {
			return err
		}

		remaining -= int64(n)
	}

	return nil
}
module github.com/ofhouse/wpress-extract

go 1.21

require (
    golang.org/x/sys v0.12.0 // indirect
)
name: Release

on:
  push:
    tags: ["v*"]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [linux, darwin, windows]
        goarch: [amd64, arm64]
        exclude:
          - goos: windows
            goarch: arm64
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Build
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        CGO_ENABLED: 0
      run: |
        OUTPUT="wpress-extract-${GOOS}-${GOARCH}"
        if [ "$GOOS" = "windows" ]; then OUTPUT+=".exe"; fi
        go build -trimpath -ldflags="-s -w" -o $OUTPUT .
        mkdir -p dist
        mv $OUTPUT dist/

    - uses: actions/upload-artifact@v4
      with:
        name: binaries
        path: dist/
        retention-days: 5

  release:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/download-artifact@v4
      with:
        name: binaries

    - uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref }}
        files: |
          wpress-extract-*
